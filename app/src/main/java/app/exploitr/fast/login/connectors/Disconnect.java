package app.exploitr.fast.login.connectors;


import android.content.Intent;
import android.os.AsyncTask;
import android.view.View;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

import androidx.localbroadcastmanager.content.LocalBroadcastManager;

import java.io.IOException;
import java.lang.ref.WeakReference;
import java.util.Objects;

import app.exploitr.fast.login.R;
import app.exploitr.fast.login.ui_access.MainActivity;
import app.exploitr.login.platinum.helpers.Constants;
import app.exploitr.fast.login.utils.DataMan;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

//todo
public class Disconnect extends AsyncTask<Void, Integer, Integer> implements Constants {

	private WeakReference<ProgressBar> gifImageView;
	private WeakReference<ImageView> imageView;
	private WeakReference<View> snackView;
	private WeakReference<TextView> ipTextNew;

	public Disconnect(ProgressBar progressBar, ImageView imageMView, View view, TextView ipText) {
		this.gifImageView = new WeakReference<>(progressBar);
		this.imageView = new WeakReference<>(imageMView);
		this.snackView = new WeakReference<>(view);
		this.ipTextNew = new WeakReference<>(ipText);
	}

	@Override
	protected void onPreExecute() {
		super.onPreExecute();
		ipTextNew.get().setVisibility(View.INVISIBLE);
		gifImageView.get().setVisibility(View.VISIBLE);
	}

	@Override
	protected Integer doInBackground(Void... params) {

		OkHttpClient connector = new OkHttpClient.Builder().build();

		Request request = new Request.Builder()
				.url(URL_TO_LOGOUT)
				.build();

		Response response = null;
		try {
			response = connector.newCall(request).execute();
		} catch (IOException e) {
			e.printStackTrace();
		}
		if (response != null) {
			if (response.body() != null) {
				Objects.requireNonNull(response.body()).close();
			}
		}
		if (response != null && response.isSuccessful()) return 1;
		else return 0;
	}

	@Override
	protected void onPostExecute(Integer integer) {
		super.onPostExecute(integer);

		gifImageView.get().setVisibility(View.INVISIBLE);

		if (integer == 0) {
			LocalBroadcastManager.getInstance(snackView.get().getContext()).sendBroadcast(new Intent(MainActivity.LOGIN_SUCCESS));
			imageView.get().setImageResource(R.drawable.isconnected);
			Toast.makeText(snackView.get().getContext(), LOGOUT_ERR, Toast.LENGTH_SHORT).show();
			ipTextNew.get().setVisibility(View.VISIBLE);
		} else {
			DataMan.getInstance(gifImageView.get().getContext().getApplicationContext()).setLogoutState(true);
			LocalBroadcastManager.getInstance(snackView.get().getContext()).sendBroadcast(new Intent(MainActivity.LOGIN_FAILURE));
			imageView.get().setImageResource(R.drawable.isconnectedx);
			ipTextNew.get().setVisibility(View.INVISIBLE);
			Toast.makeText(snackView.get().getContext(), LOGOUT_OK, Toast.LENGTH_SHORT).show();
			snackView.get().setVisibility(View.INVISIBLE);
		}

	}

}

