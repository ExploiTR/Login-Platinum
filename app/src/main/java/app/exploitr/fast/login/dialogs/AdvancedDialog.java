package app.exploitr.fast.login.dialogs;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.app.Dialog;
import android.app.DialogFragment;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.os.Process;
import android.view.View;
import android.widget.ImageButton;
import android.widget.Switch;
import android.widget.Toast;

import androidx.appcompat.app.AlertDialog;

import app.exploitr.fast.login.R;
import app.exploitr.fast.login.utils.DataMan;

/**
 * See MainActivity.class#launchSettings
 */
@SuppressLint("InflateParams")
public class AdvancedDialog extends DialogFragment {

    Intent intent;
    Activity activity;

    public AdvancedDialog() {
    }

    @Override
    public Dialog onCreateDialog(Bundle savedInstanceState) {
        intent = getActivity().getIntent();
        activity = getActivity();

        View advancedView = getActivity().getLayoutInflater().inflate(R.layout.content_alert_advanced, null);

        final Switch enable_auto = advancedView.findViewById(R.id.enable_auto);
        final Switch enable_periodic = advancedView.findViewById(R.id.enable_periodic);
        Switch enable_notification = advancedView.findViewById(R.id.enable_notification);

        enable_auto.setChecked(DataMan.getInstance(getActivity().getBaseContext()).getPureAutoLogin());
        enable_periodic.setChecked(DataMan.getInstance(getActivity().getBaseContext()).getPeriodic());
        enable_notification.setChecked(DataMan.getInstance(getActivity().getBaseContext()).getNotificationsEnabled());

        ImageButton enable_auto_help = advancedView.findViewById(R.id.enable_auto_help);
        ImageButton enable_periodic_help = advancedView.findViewById(R.id.enable_periodic_help);
        ImageButton enable_notification_help = advancedView.findViewById(R.id.enable_notification_help);

        enable_auto_help.setOnClickListener(v -> getTempAlt("About Auto-Login", getString(R.string.auto_help), null).show());
        enable_periodic_help.setOnClickListener(v -> getTempAlt("About Periodic Login Check", getString(R.string.auto_help_), null).show());
        enable_notification_help.setOnClickListener(v -> getTempAlt("About Notifications", getString(R.string.dis_dis), null).show());

        enable_auto.setOnCheckedChangeListener((buttonView, isChecked) -> {
            if (isChecked &&
                    DataMan.getInstance(getActivity().getBaseContext()).getUser() != null
                    && DataMan.getInstance(getActivity().getBaseContext()).getPassword() != null) {
                DataMan.getInstance(getActivity().getBaseContext()).setPureAutoLogin(true);
            } else {
                Toast.makeText(activity, "You need to first configure uname/pwd", Toast.LENGTH_SHORT).show();
                enable_auto.setChecked(false);
            }
        });
        enable_periodic.setOnCheckedChangeListener((buttonView, isChecked) -> {
            if (isChecked &&
                    DataMan.getInstance(getActivity().getBaseContext()).getUser() != null
                    && DataMan.getInstance(getActivity().getBaseContext()).getPassword() != null) {
                DataMan.getInstance(getActivity().getBaseContext()).setPeriodic(true);
            } else {
                Toast.makeText(activity, "You need to first configure uname/pwd", Toast.LENGTH_SHORT).show();
                enable_periodic.setChecked(false);
            }
        });
        enable_notification.setOnCheckedChangeListener((buttonView, isChecked) -> DataMan.getInstance(getActivity().getBaseContext()).setNotificationsEnabled(isChecked));

        return new AlertDialog.Builder(getActivity())
                .setView(advancedView)
                .setPositiveButton("Done", (dialog, which) -> getTempAlt("Alert", "Please manually restart app", (dialog1, which1) -> {
                    Process.killProcess(Process.myPid());
                    System.exit(10);
                }).show())
                .show();
    }

    private AlertDialog.Builder getTempAlt(String title, String what, DialogInterface.OnClickListener listener) {
        return new AlertDialog.Builder(getActivity()).setTitle(title).setMessage(what)
                .setCancelable(false).setPositiveButton("Ok", listener);
    }
}
